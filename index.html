<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Supervisor QA - SiperQA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .active-tab { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: bold; background-color: #eff6ff; }
        .header-blue { background-color: #3b82f6; color: white; font-weight: bold; }
        #loginOverlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .tooltip-container { position: relative; cursor: help; }
        .tooltip-text { 
            visibility: hidden; width: 280px; background-color: #1e293b; color: #fff; 
            text-align: left; border-radius: 8px; padding: 12px; position: fixed; 
            z-index: 10000; opacity: 0; transition: opacity 0.3s; font-size: 11px; 
            font-weight: normal; line-height: 1.4; border: 1px solid #3b82f6;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); pointer-events: none;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        .critical-row { background-color: #fff1f2; }
        .btn-press:active { transform: scale(0.96); transition: 0.1s; }
        
        /* Spinner sencillo */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Estilos tabla ordenable */
        th.sortable { cursor: pointer; position: relative; }
        th.sortable:hover { background-color: #f1f5f9; }
    </style>
</head>
<body class="bg-slate-50 font-sans h-screen flex flex-col overflow-hidden">

    <div id="loginOverlay">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center border-t-4 border-blue-500">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Acceso Supervisor</h2>
            <select id="loginSelect" class="w-full p-3 border-2 border-gray-200 rounded-xl mb-6 font-bold text-gray-700 outline-none focus:border-blue-500 bg-gray-50">
                <option value="">-- Selecciona tu Nombre --</option>
            </select>
            <button onclick="iniciarSesion()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition shadow-lg btn-press">
                INGRESAR
            </button>
        </div>
    </div>

    <nav class="bg-white border-b border-gray-200 px-6 py-3 flex justify-between items-center shadow-sm z-40">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white w-8 h-8 rounded flex items-center justify-center font-bold">S</div>
            <div>
                <span class="font-bold text-gray-700 block leading-tight">Consola Supervisor</span>
                <span id="labelSupervisor" class="text-[10px] text-blue-600 font-bold uppercase tracking-wider">Sin identificar</span>
            </div>
        </div>
        <div class="flex gap-2 text-sm bg-gray-100 p-1 rounded-lg">
            <button onclick="cambiarTab('tabIngreso')" id="btnTabIngreso" class="tab-btn active-tab px-4 py-2 rounded-md transition btn-press">üìù Auditar</button>
            <button onclick="cambiarTab('tabDashboard')" id="btnTabDashboard" class="tab-btn px-4 py-2 rounded-md transition text-gray-500 hover:text-gray-800 btn-press">üìä Mi Equipo</button>
        </div>
    </nav>

    <div id="tabIngreso" class="tab-content p-4 overflow-y-auto flex-1">
        <div class="max-w-6xl mx-auto bg-white p-6 rounded-xl shadow border border-gray-200">
            <form id="auditForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-slate-50 p-4 rounded-lg border border-gray-200">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Ejecutivo</label>
                        <select id="selectEjecutivo" name="nombre" class="w-full border rounded p-2 font-bold text-sm bg-white" required onchange="autocompletarDatos()">
                            <option value="">-- Seleccionar --</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">C√≥digo</label>
                        <input type="text" id="inputCodigo" name="codigo" class="w-full bg-gray-100 border rounded p-2 text-sm font-mono" readonly>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Supervisor</label>
                        <input type="text" id="inputSup" name="supervisor" class="w-full bg-gray-100 border rounded p-2 text-sm" readonly>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Servicio</label>
                        <input type="text" id="inputServ" name="servicio" class="w-full bg-gray-100 border rounded p-2 text-sm" readonly>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Fecha Llamada</label>
                        <input type="date" id="fechaLlamada" name="fecha_llamada" class="w-full border rounded p-2 text-sm" required onchange="calcularSemana()">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Hora Llamada</label>
                        <input type="time" name="hora_llamada" class="w-full border rounded p-2 text-sm" required>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-blue-600 uppercase">RUT Paciente</label>
                        <input type="text" name="rut_paciente" class="w-full border-2 border-blue-100 rounded p-2 text-sm" required placeholder="12.345.678-9">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">URL Audio (Opcional)</label>
                        <input type="url" name="audio_url" class="w-full border rounded p-2 text-sm" placeholder="https://...">
                    </div>
                </div>

                <input type="hidden" id="inputSemana" name="semana">
                <input type="hidden" id="fechaAuditoria" name="fecha_auditoria">
                <input type="hidden" id="inputAuditorReal" name="auditor_real">
                <input type="hidden" id="notaFinalHidden" name="nota_final" value="0%">

                <div class="overflow-x-auto rounded border border-gray-300">
                    <table class="w-full text-[11px]">
                        <thead>
                            <tr class="header-blue text-center uppercase">
                                <th class="p-2 w-24">Categor√≠a</th>
                                <th class="p-2 text-left">Indicador</th>
                                <th class="p-2 w-16">Tipo</th>
                                <th class="p-2 w-24">Cumple</th>
                                <th class="p-2 w-48 bg-slate-700 text-white">Observaci√≥n de Quiebre</th>
                            </tr>
                        </thead>
                        <tbody id="pautaBody" class="divide-y divide-gray-200"></tbody>
                        <tfoot>
                            <tr class="bg-gray-800 text-white">
                                <td colspan="4" class="p-3 text-right font-bold text-sm uppercase">Nota Final:</td>
                                <td class="p-3 text-center font-black text-2xl" id="totalScore">100%</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Comentario General y Feedback</label>
                    <textarea id="comentarioFinal" name="comentario" class="w-full border p-3 rounded h-32 text-sm bg-white" placeholder="Escribe aqu√≠ tu an√°lisis general de la llamada..."></textarea>
                </div>
                
                <button type="submit" id="btnGuardar" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-700 btn-press">
                    <i class="fas fa-save mr-2"></i> GUARDAR AUDITOR√çA
                </button>
            </form>
        </div>
    </div>

    <div id="tabDashboard" class="tab-content hidden p-4 overflow-y-auto flex-1 bg-slate-100">
        <div class="max-w-6xl mx-auto space-y-4">
            
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Mes / Ciclo</label>
                    <select id="filtroCiclo" class="w-full border rounded p-2 text-sm bg-gray-50" onchange="cargarDashboardEquipo()">
                        <option value="">Cargando Ciclos...</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Ejecutivo</label>
                    <input type="text" id="filtroEjecutivo" list="listaEjecutivosFiltro" class="w-full border rounded p-2 text-sm bg-gray-50" placeholder="Buscar nombre...">
                    <datalist id="listaEjecutivosFiltro"></datalist>
                </div>
                <div class="flex gap-2">
                    <button onclick="cargarDashboardEquipo()" class="flex-1 bg-blue-600 text-white p-2 rounded-lg btn-press text-xs font-bold flex items-center justify-center gap-2">
                        <span id="loadSpinner" class="hidden"><div class="loader" style="width:12px; height:12px; border-width:2px;"></div></span>
                        <i class="fas fa-sync-alt"></i> ACTUALIZAR
                    </button>
                    <button onclick="borrarFiltros()" class="flex-1 bg-gray-500 text-white p-2 rounded-lg btn-press text-xs font-bold">
                        <i class="fas fa-eraser"></i> BORRAR
                    </button>
                </div>
            </div>

            <div id="containerTarjetas" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3"></div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500 text-center">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Promedio Equipo</p>
                    <p class="text-3xl font-black text-slate-700" id="dashProm">0%</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-purple-500 text-center">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Ciclos Feedback</p>
                    <p class="text-3xl font-black text-slate-700" id="kpiFeedbackCount">0/0</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500 text-center">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Casos PEC</p>
                    <p class="text-3xl font-black text-red-600" id="dashPec">0</p>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <table class="w-full text-xs" id="tableMain">
                    <thead class="bg-slate-100 text-gray-500 uppercase">
                        <tr>
                            <th class="p-3 text-left sortable" onclick="sortTable(0)">Ejecutivo <i class="fas fa-sort"></i></th>
                            <th class="p-3 text-center sortable" onclick="sortTable(1)">Fecha <i class="fas fa-sort"></i></th>
                            <th class="p-3 text-center sortable" onclick="sortTable(2)">Nota <i class="fas fa-sort"></i></th>
                            <th class="p-3 text-center sortable" onclick="sortTable(3)">Feedback <i class="fas fa-sort"></i></th>
                            <th class="p-3 text-center">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="tablaEquipo" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbygEAhS5jdllKf89ecmom2mmay3sCDU8qOyGsTl6Yixy3JpiRumYWvhMVtLtfdF2wZqUA/exec";
        let CURRENT_USER = "";
        let FULL_DATA = [];

        const baseEjecutivos = [
            {nombre:"Andreina Villalon Mej√≠as", codigo:"CC1683", sup:"Luis Cataldo", serv:"Bloqueo"},
            {nombre:"Oscar Hidalgo Luco", codigo:"CC9827", sup:"Luis Cataldo", serv:"Bloqueo"},
            {nombre:"Lorena Rodriguez Salazar", codigo:"CC4346", sup:"Luis Cataldo", serv:"Bloqueo"},
            {nombre:"Angelica Galleguillos Abarca", codigo:"CC5251", sup:"Luis Cataldo", serv:"Bloqueo"},
            {nombre:"Miriam Bruges De Torres", codigo:"CC0928", sup:"Ang√©lica Ferrada", serv:"Ingreso"},
            {nombre:"Cristobal Fernandez Azares", codigo:"CC0315", sup:"Ang√©lica Ferrada", serv:"Ingreso"},
            {nombre:"Carla Garay Vidal", codigo:"CC5070", sup:"Ang√©lica Ferrada", serv:"Ingreso"},
            {nombre:"Jorge Yanez Cort√©s", codigo:"CC2467", sup:"Ang√©lica Ferrada", serv:"Ingreso"},
            {nombre:"Maria Paz Nu√±ez Baeza", codigo:"CC5178", sup:"Ang√©lica Ferrada", serv:"Ingreso"},
            {nombre:"Diego Cea Brice√±o", codigo:"CC7625", sup:"Carla Cabrera", serv:"Mesa Central"},
            {nombre:"Edith Ossandon Montoya", codigo:"CC2762", sup:"Carla Cabrera", serv:"Mesa Central"},
            {nombre:"Johanna Herrera Merida", codigo:"CC7119", sup:"Carla Cabrera", serv:"Mesa Central"},
            {nombre:"Lesli Agudelo Viveros", codigo:"CC3118", sup:"Carla Cabrera", serv:"Mesa Central"},
            {nombre:"Maria Cristina Bar√≥n Bar√≥n", codigo:"CC1815", sup:"Carla Cabrera", serv:"Mesa Central"},
            {nombre:"Yessenia Gonzalez Gonz√°lez", codigo:"CC6869", sup:"Carla Cabrera", serv:"Mesa Central"},
            {nombre:"Paola Herrera Barriga", codigo:"CC3898", sup:"Carla Cabrera", serv:"Mesa Central"},
            {nombre:"Adrian Manzanilla Rangel", codigo:"CC0506", sup:"Carla Cabrera", serv:"Mesa Central"},
            {nombre:"Mar√≠a Far√≠as Quintero", codigo:"CC0851", sup:"Carla Cabrera", serv:"Mesa Central"},
            {nombre:"Saymar Pa√©z Garc√≠a", codigo:"CC1992", sup:"Aracely Torres", serv:"FDS"},
            {nombre:"Katya C√°ceres Gonz√°lez", codigo:"CC1225", sup:"Aracely Torres", serv:"FDS"},
            {nombre:"Belfred Belis Mijares", codigo:"CC8219", sup:"Aracely Torres", serv:"FDS"},
            {nombre:"Carla Cabrera Lara", codigo:"S5388", sup:"Aracely Torres", serv:"HLF"},
            {nombre:"Aracely Torres Fa√∫ndez", codigo:"S7637", sup:"Aracely Torres", serv:"HLF"},
            {nombre:"Luis Cataldo Galaz", codigo:"S2065", sup:"Aracely Torres", serv:"HLF"},
            {nombre:"Mar√≠a Ang√©lica Ferrada Cea", codigo:"S7705", sup:"Aracely Torres", serv:"HLF"},
            {nombre:"Marco Lara Vera", codigo:"S0226", sup:"Aracely Torres", serv:"HLF"}
        ];

        const pautaItems = [
            { cat: "SEGURIDAD", id: "item_validacion", label: "Validaci√≥n Identidad", type: "PEC", tip: "Solicita RUT y Nombre. Si es tercero, datos de ambos." },
            { cat: "SEGURIDAD", id: "item_confidencialidad", label: "Confidencialidad", type: "PEC", tip: "No informar diagn√≥sticos sensibles sin validar titularidad." },
            { cat: "CONDUCTA", id: "item_normas", label: "Normas Conducta", type: "PEC", tip: "Lenguaje formal, evita ruidos molestos o faltas de respeto." },
            { cat: "OPERACI√ìN", id: "item_abandono", label: "Abandono", type: "PEC", tip: "Cortar o dejar en espera infinita (Max 35 seg de silencio)." },
            { cat: "SISTEMA", id: "item_registro", label: "Registro", type: "PEC", tip: "Deja registro de la gesti√≥n en CRM/HIS seg√∫n protocolo." },
            { cat: "PROTOCOLO", id: "item_script", label: "Script Inicio/Cierre", type: "PENC", weight: 5, tip: "Saludo y despedida institucional est√°ndar." },
            { cat: "PROTOCOLO", id: "item_cortesia", label: "Cortes√≠a y Trato", type: "PENC", weight: 5, tip: "Cordialidad y amabilidad durante la llamada." },
            { cat: "GESTI√ìN", id: "item_sondeo", label: "Sondeo", type: "PENC", weight: 15, tip: "Preguntas clave para entender la necesidad del paciente." },
            { cat: "GESTI√ìN", id: "item_info", label: "Entrega Informaci√≥n", type: "PENC", weight: 20, tip: "Informa sobre horas, requisitos y ubicaciones correctamente." },
            { cat: "GESTI√ìN", id: "item_tiempos", label: "Manejo Tiempos", type: "PENC", weight: 10, tip: "Evita esperas innecesarias y gestiona con agilidad." },
            { cat: "GESTI√ìN", id: "item_aseguramiento", label: "Aseguramiento", type: "PENC", weight: 10, tip: "Confirma que el paciente entendi√≥ la informaci√≥n." },
            { cat: "HABILIDADES", id: "item_personalizacion", label: "Personalizaci√≥n", type: "PENC", weight: 5, tip: "Usa el nombre del paciente durante la llamada." },
            { cat: "HABILIDADES", id: "item_lenguaje", label: "Lenguaje/Dicci√≥n", type: "PENC", weight: 5, tip: "Modulaci√≥n correcta, sin muletillas ni tecnicismos." },
            { cat: "HABILIDADES", id: "item_empatia", label: "Empat√≠a", type: "PENC", weight: 10, tip: "Valida la preocupaci√≥n o urgencia del usuario." },
            { cat: "SISTEMAS", id: "item_tipificacion", label: "Tipificaci√≥n/Glosa", type: "PENC", weight: 15, tip: "Tipifica motivo y deja glosa explicativa clara." }
        ];

        const mesesNombres = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        window.onload = () => {
            const supervisores = [...new Set(baseEjecutivos.map(e => e.sup))].sort();
            const select = document.getElementById('loginSelect');
            supervisores.forEach(s => {
                let opt = document.createElement('option'); opt.value = s; opt.innerText = s;
                select.appendChild(opt);
            });
            renderPauta();
        };

        function iniciarSesion() {
            const user = document.getElementById('loginSelect').value;
            if(!user) return Swal.fire("Atenci√≥n", "Selecciona tu nombre", "warning");
            CURRENT_USER = user;
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('labelSupervisor').innerText = user;
            const selectEjec = document.getElementById('selectEjecutivo');
            selectEjec.innerHTML = '<option value="">-- Seleccionar --</option>';
            baseEjecutivos.filter(e => e.sup === user).forEach(e => {
                let opt = document.createElement('option'); opt.value = e.nombre; opt.innerText = e.nombre;
                selectEjec.appendChild(opt);
            });
        }

        function autocompletarDatos() {
            const nombre = document.getElementById('selectEjecutivo').value;
            const data = baseEjecutivos.find(e => e.nombre === nombre);
            if(data) {
                document.getElementById('inputCodigo').value = data.codigo;
                document.getElementById('inputServ').value = data.serv;
                document.getElementById('inputSup').value = data.sup;
                document.getElementById('inputAuditorReal').value = CURRENT_USER;
            }
        }

        function renderPauta() {
            const body = document.getElementById('pautaBody');
            body.innerHTML = "";
            pautaItems.forEach(item => {
                const tr = document.createElement('tr');
                if(item.type === "PEC") tr.className = "critical-row";
                tr.innerHTML = `
                    <td class="p-2 font-bold ${item.type === 'PEC' ? 'text-red-700' : 'text-slate-500'}">${item.cat}</td>
                    <td class="p-2">
                        <div class="tooltip-container">
                            <span class="font-medium">${item.label}</span>
                            <div class="tooltip-text">${item.tip}</div>
                        </div>
                    </td>
                    <td class="p-2 text-center font-bold ${item.type === 'PEC' ? 'text-red-500' : 'text-blue-500'}">${item.type === 'PEC' ? 'PEC' : item.weight+'%'}</td>
                    <td class="p-1"><select name="${item.id}" class="w-full border rounded p-1 calc-trigger" data-id="${item.id}" data-type="${item.type}" data-weight="${item.weight || 0}" onchange="toggleObs(this)"><option value="SI">SI</option><option value="NO">NO</option></select></td>
                    <td class="p-1"><input type="text" id="obs_${item.id}" class="obs-input w-full border border-blue-200 rounded p-1 hidden text-[10px]" placeholder="¬øPor qu√© no cumple?"></td>
                `;
                body.appendChild(tr);
            });
        }

        function toggleObs(select) {
            const input = document.getElementById('obs_' + select.dataset.id);
            if(select.value === 'NO') input.classList.remove('hidden');
            else { input.classList.add('hidden'); input.value = ""; }
            calculateScore();
        }

        function calculateScore() {
            let total = 0, isPec = false;
            document.querySelectorAll('.calc-trigger').forEach(sel => {
                if(sel.dataset.type === "PEC" && sel.value === "NO") isPec = true;
                if(sel.dataset.type === "PENC" && sel.value === "SI") total += parseInt(sel.dataset.weight);
            });
            const nota = isPec ? 0 : total;
            document.getElementById('totalScore').innerText = nota + "%";
            document.getElementById('notaFinalHidden').value = nota + "%";
        }

        function calcularSemana() {
            const f = document.getElementById('fechaLlamada').value;
            const d = new Date(f).getUTCDate();
            const s = Math.ceil(d/7);
            document.getElementById('inputSemana').value = "Semana " + (s > 4 ? 4 : s);
        }

        function cambiarTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
            document.getElementById(id).classList.remove('hidden');
            const btnId = id === 'tabIngreso' ? 'btnTabIngreso' : 'btnTabDashboard';
            document.getElementById(btnId).classList.add('active-tab');
            if(id === 'tabDashboard') cargarDashboardEquipo();
        }

        // --- DASHBOARD ---
        function borrarFiltros() {
            document.getElementById('filtroCiclo').value = "";
            document.getElementById('filtroEjecutivo').value = "";
            cargarDashboardEquipo();
        }

        async function cargarDashboardEquipo() {
            const spinner = document.getElementById('loadSpinner');
            spinner.classList.remove('hidden');
            try {
                const r = await fetch(API_URL);
                const data = await r.json();
                FULL_DATA = data;
                let filtrados = data.filter(d => d.SUPERVISOR === CURRENT_USER);

                // Generar opciones de Ciclo (Mes - Semana) din√°micamente seg√∫n lo que hay
                const selectCiclo = document.getElementById('filtroCiclo');
                const cicloSeleccionado = selectCiclo.value;
                const ciclosDisponibles = [...new Set(filtrados.map(d => {
                    const m = parseInt(d.FECHA_LLAMADA.split('-')[1]) - 1;
                    return `${mesesNombres[m]} - ${d.SEMANA}`;
                }))].sort();

                selectCiclo.innerHTML = '<option value="">Todos los Ciclos</option>';
                ciclosDisponibles.forEach(c => {
                    let opt = document.createElement('option'); opt.value = c; opt.innerText = c;
                    selectCiclo.appendChild(opt);
                });
                if(cicloSeleccionado) selectCiclo.value = cicloSeleccionado;

                // Aplicar Filtro de Ciclo
                if(selectCiclo.value) {
                    filtrados = filtrados.filter(d => {
                        const m = parseInt(d.FECHA_LLAMADA.split('-')[1]) - 1;
                        return `${mesesNombres[m]} - ${d.SEMANA}` === selectCiclo.value;
                    });
                }

                const ejec = document.getElementById('filtroEjecutivo').value.toLowerCase();
                if(ejec) filtrados = filtrados.filter(d => d.NOMBRE.toLowerCase().includes(ejec));

                // Datalist
                const list = document.getElementById('listaEjecutivosFiltro');
                const nombresUnicos = [...new Set(filtrados.map(d => d.NOMBRE))];
                list.innerHTML = ""; nombresUnicos.forEach(n => { let opt = document.createElement('option'); opt.value = n; list.appendChild(opt); });

                // Tarjetas
                const containerTarjetas = document.getElementById('containerTarjetas');
                containerTarjetas.innerHTML = "";
                nombresUnicos.forEach(nombre => {
                    const audsEjec = filtrados.filter(d => d.NOMBRE === nombre);
                    const prom = (audsEjec.reduce((a, b) => a + (parseInt(b.NOTA_FINAL) || 0), 0) / audsEjec.length).toFixed(0);
                    const count = audsEjec.length;
                    containerTarjetas.innerHTML += `
                        <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 text-center btn-press cursor-pointer" onclick="document.getElementById('filtroEjecutivo').value='${nombre}'; cargarDashboardEquipo();">
                            <p class="text-[9px] font-bold text-gray-400 uppercase truncate">${nombre}</p>
                            <p class="text-xl font-black text-blue-600">${prom}%</p>
                            <p class="text-2xl font-black ${count === 0 ? 'text-red-600 animate-pulse' : 'text-slate-700'}">${count}</p>
                            <p class="text-[9px] text-gray-400 uppercase">Auditor√≠as</p>
                        </div>`;
                });

                const notas = filtrados.map(d => parseInt(d.NOTA_FINAL) || 0);
                document.getElementById('dashProm').innerText = (notas.length ? (notas.reduce((a,b)=>a+b,0)/notas.length).toFixed(0) : 0) + "%";
                document.getElementById('dashPec').innerText = notas.filter(n => n === 0).length;
                document.getElementById('kpiFeedbackCount').innerText = `${filtrados.filter(d => d.FEEDBACK_STATUS === "REALIZADO").length}/${filtrados.length}`;

                const tb = document.getElementById('tablaEquipo'); tb.innerHTML = "";
                filtrados.forEach((d, idx) => {
                    const isDone = d.FEEDBACK_STATUS === "REALIZADO";
                    const row = document.createElement('tr');
                    row.className = "hover:bg-blue-50 transition cursor-pointer";
                    row.onclick = () => verDetalleAuditoria(d);
                    row.innerHTML = `
                        <td class="p-3 font-medium">${d.NOMBRE}</td>
                        <td class="p-3 text-center">${d.FECHA_LLAMADA}</td>
                        <td class="p-3 text-center font-bold ${parseInt(d.NOTA_FINAL) < 85 ? 'text-red-500':'text-green-600'}">${d.NOTA_FINAL}</td>
                        <td class="p-3 text-center"><span class="px-2 py-0.5 rounded-full text-[9px] font-bold ${isDone ? 'bg-green-100 text-green-700':'bg-amber-100 text-amber-700'}">${d.FEEDBACK_STATUS}</span></td>
                        <td class="p-3 text-center" onclick="event.stopPropagation();">
                            ${!isDone ? `<button onclick="abrirFeedback('${d.CODIGO}', '${d.FECHA_AUDITORIA}')" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 btn-press">Feedback</button>` : '‚úÖ'}
                        </td>`;
                    tb.appendChild(row);
                });
            } catch (e) { console.error(e); } finally { spinner.classList.add('hidden'); }
        }

        function verDetalleAuditoria(data) {
            let pautaDetalle = "";
            if(data.DETALLE) {
                pautaDetalle = `<div class="mt-4 p-3 bg-red-50 rounded text-left text-xs border border-red-100"><p class="font-bold text-red-700 mb-2">INDICADORES NO CUMPLIDOS:</p>`;
                let count = 0;
                for (const [key, val] of Object.entries(data.DETALLE)) {
                    if(val === "NO") {
                        const item = pautaItems.find(p => p.id === key.toLowerCase() || p.id === "item_" + key.toLowerCase().split('_')[1]);
                        pautaDetalle += `<p class="mb-1">‚ùå <b>${item ? item.label : key}:</b> Marcado como NO.</p>`;
                        count++;
                    }
                }
                if(count === 0) pautaDetalle = `<div class="mt-4 p-3 bg-green-50 rounded text-left text-xs border border-green-100"><p class="font-bold text-green-700">Cumplimiento total de indicadores.</p>`;
                pautaDetalle += `</div>`;
            }

            const audioHtml = data.AUDIO_URL && data.AUDIO_URL.trim() !== "" ? 
                `<div class="mt-4 bg-slate-100 p-3 rounded border border-gray-200">
                    <p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Escuchar Grabaci√≥n:</p>
                    <audio controls class="w-full h-8"><source src="${data.AUDIO_URL}" type="audio/mpeg">Tu navegador no soporta el audio.</audio>
                </div>` : 
                `<div class="mt-4 bg-amber-50 p-3 rounded border border-amber-200 text-amber-700 text-xs italic">La URL del audio no est√° disponible para esta auditor√≠a.</div>`;

            Swal.fire({
                title: `<span class="text-blue-600">${data.NOMBRE}</span>`,
                html: `
                    <div class="text-sm border-t pt-4">
                        <div class="grid grid-cols-2 gap-2 text-left mb-4">
                            <div><p class="text-[9px] font-bold text-gray-400 uppercase">RUT Paciente</p>
                                <div class="flex items-center gap-2">
                                    <span class="font-bold">${data.RUT_PACIENTE || 'N/A'}</span>
                                    <button onclick="copyToClipboard('${data.RUT_PACIENTE}')" class="text-blue-500 text-xs"><i class="fas fa-copy"></i></button>
                                </div>
                            </div>
                            <div><p class="text-[9px] font-bold text-gray-400 uppercase">Nota Final</p><p class="text-xl font-black text-blue-600">${data.NOTA_FINAL}</p></div>
                            <div><p class="text-[9px] font-bold text-gray-400 uppercase">Fecha Llamada</p><p class="font-bold">${data.FECHA_LLAMADA}</p></div>
                            <div><p class="text-[9px] font-bold text-gray-400 uppercase">Hora</p><p class="font-bold">${data.HORA_LLAMADA}</p></div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded text-left text-xs border italic">
                            <p class="font-bold text-gray-500 not-italic uppercase mb-1">Comentario General:</p>
                            ${data.COMENTARIO || 'Sin comentarios.'}
                        </div>
                        ${pautaDetalle}
                        ${audioHtml}
                    </div>
                `,
                showCloseButton: true,
                confirmButtonText: 'Cerrar',
                width: '500px'
            });
        }

        function copyToClipboard(txt) {
            navigator.clipboard.writeText(txt);
            Swal.showValidationMessage('¬°Copiado!');
        }

        function sortTable(n) {
            const table = document.getElementById("tableMain");
            let switching = true, shouldSwitch, i, x, y, dir = "asc", switchcount = 0;
            while (switching) {
                switching = false;
                const rows = table.rows;
                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName("TD")[n];
                    y = rows[i + 1].getElementsByTagName("TD")[n];
                    if (dir == "asc") {
                        if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) { shouldSwitch = true; break; }
                    } else if (dir == "desc") {
                        if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) { shouldSwitch = true; break; }
                    }
                }
                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                    switchcount ++;      
                } else {
                    if (switchcount == 0 && dir == "asc") { dir = "desc"; switching = true; }
                }
            }
        }

        async function abrirFeedback(cod, fecha) {
            const { value: texto } = await Swal.fire({ title: 'Cerrar Ciclo', input: 'textarea', inputLabel: 'Compromisos...', showCancelButton: true });
            if (texto) {
                const payload = { action: "REGISTER_FEEDBACK", codigo: cod, fecha_auditoria: fecha, feedback_detalle: texto };
                try { await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) }); Swal.fire("√âxito", "Feedback guardado", "success"); cargarDashboardEquipo(); } catch (e) { Swal.fire("Error", "No se pudo guardar", "error"); }
            }
        }

        document.getElementById('auditForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            let textoFeedback = document.getElementById('comentarioFinal').value;
            let quiebres = [];
            pautaItems.forEach(item => {
                const sel = document.querySelector(`select[name="${item.id}"]`);
                const obs = document.getElementById('obs_' + item.id).value;
                if(sel.value === 'NO') {
                    let peso = item.type === "PEC" ? "PEC" : item.weight + "%";
                    quiebres.push(`‚Ä¢ ${item.label} (${peso}): ${obs || 'Sin observaci√≥n'}`);
                }
            });
            if(quiebres.length > 0) textoFeedback += (textoFeedback ? "\n\n" : "") + "--- DETALLE ---\n" + quiebres.join('\n');
            document.getElementById('comentarioFinal').value = textoFeedback;
            const btn = document.getElementById('btnGuardar');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            document.getElementById('fechaAuditoria').value = new Date().toISOString().split('T')[0];
            const data = Object.fromEntries(new FormData(this));
            try {
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
                Swal.fire("√âxito", "Guardado", "success"); this.reset(); renderPauta();
                document.getElementById('totalScore').innerText = "100%";
                document.getElementById('comentarioFinal').value = "";
            } catch (err) { Swal.fire("Error", "Error", "error"); } finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-save mr-2"></i> GUARDAR'; }
        });
    </script>
</body>
</html>
